{% extends "base.html" %}

{% block title %}Dashboard - FIM System{% endblock %}

{% block extra_head %}
<style>
    .info-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .modal-body {
        font-family: monospace;
    }
    .hash-value {
        word-break: break-all;
        background-color: #f8f9fa;
        padding: 0.5rem;
        border-radius: 0.25rem;
    }
    .advanced-filter {
        display: none;
    }
    .advanced-filter.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">File Integrity Monitoring Dashboard</h1>

<!-- Search and Filter Button Section -->
<div class="row mb-3">
    <div class="col-md-8">
        <form method="GET" action="/" id="mainForm">
            <div class="input-group">
                <input type="text" 
                       class="form-control" 
                       name="search" 
                       placeholder="Search..." 
                       value="{{ search_query }}"
                       id="searchInput">
                <button type="button" 
                        class="btn btn-secondary" 
                        id="filterToggleBtn"
                        onclick="toggleAdvancedFilter()">
                    Filter
                </button>
            </div>
            
            <!-- Hidden fields for event types and columns -->
            <input type="hidden" name="types" id="eventTypesInput" value="">
            <input type="hidden" name="columns" id="searchColumnsInput" value="">
        </form>
    </div>
</div>

<!-- Advanced Filter Section -->
<div class="card mb-4 advanced-filter{% if has_active_filters %} show{% endif %}" id="advancedFilter">
    <div class="card-header">
        <h5 class="mb-0">Advanced Filters</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="/" id="filterForm">
            <input type="hidden" name="search" value="{{ search_query }}">
            
            <!-- Column-based search scope -->
            <div class="mb-3">
                <label class="form-label fw-bold">Search in columns:</label>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input column-checkbox" 
                                   type="checkbox" 
                                   id="colAll" 
                                   value="all"
                                   {% if 'all' in selected_search_columns or not selected_search_columns or selected_search_columns|length == 0 %}checked{% endif %}>
                            <label class="form-check-label" for="colAll">All</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input column-checkbox" 
                                   type="checkbox" 
                                   id="colTimestamp" 
                                   value="timestamp"
                                   {% if 'timestamp' in selected_search_columns %}checked{% endif %}>
                            <label class="form-check-label" for="colTimestamp">Timestamp</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input column-checkbox" 
                                   type="checkbox" 
                                   id="colEventType" 
                                   value="event_type"
                                   {% if 'event_type' in selected_search_columns %}checked{% endif %}>
                            <label class="form-check-label" for="colEventType">Event Type</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input column-checkbox" 
                                   type="checkbox" 
                                   id="colFilePath" 
                                   value="file_path"
                                   {% if 'file_path' in selected_search_columns %}checked{% endif %}>
                            <label class="form-check-label" for="colFilePath">File Path</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input column-checkbox" 
                                   type="checkbox" 
                                   id="colEndpoint" 
                                   value="endpoint"
                                   {% if 'endpoint' in selected_search_columns %}checked{% endif %}>
                            <label class="form-check-label" for="colEndpoint">Endpoint</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input column-checkbox" 
                                   type="checkbox" 
                                   id="colHostname" 
                                   value="hostname"
                                   {% if 'hostname' in selected_search_columns %}checked{% endif %}>
                            <label class="form-check-label" for="colHostname">Hostname</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input column-checkbox" 
                                   type="checkbox" 
                                   id="colUsername" 
                                   value="username"
                                   {% if 'username' in selected_search_columns %}checked{% endif %}>
                            <label class="form-check-label" for="colUsername">Username</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Event type filter -->
            <div class="mb-3">
                <label class="form-label fw-bold">Filter by event type:</label>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input event-type-checkbox" 
                                   type="checkbox" 
                                   id="eventAll" 
                                   value="all"
                                   {% if 'all' in selected_event_types or not selected_event_types or selected_event_types|length == 0 %}checked{% endif %}>
                            <label class="form-check-label" for="eventAll">All</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input event-type-checkbox" 
                                   type="checkbox" 
                                   id="eventCreated" 
                                   value="created"
                                   {% if 'created' in selected_event_types %}checked{% endif %}>
                            <label class="form-check-label" for="eventCreated">Created</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input event-type-checkbox" 
                                   type="checkbox" 
                                   id="eventModified" 
                                   value="modified"
                                   {% if 'modified' in selected_event_types %}checked{% endif %}>
                            <label class="form-check-label" for="eventModified">Modified</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input event-type-checkbox" 
                                   type="checkbox" 
                                   id="eventDeleted" 
                                   value="deleted"
                                   {% if 'deleted' in selected_event_types %}checked{% endif %}>
                            <label class="form-check-label" for="eventDeleted">Deleted</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <button type="button" class="btn btn-secondary" onclick="resetFilters()">Reset</button>
            </div>
        </form>
    </div>
</div>

<!-- Events Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Recent Events (Latest 100)</h5>
    </div>
    <div class="card-body p-0">
        {% if events %}
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Timestamp</th>
                        <th>Event Type</th>
                        <th>File Path</th>
                        <th>Endpoint</th>
                        <th>Hostname</th>
                        <th>Username</th>
                        <th>Info</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr>
                        <td>{{ event.timestamp }}</td>
                        <td>
                            <span class="badge 
                                {% if event.event_type == 'created' %}bg-success
                                {% elif event.event_type == 'modified' %}bg-warning text-dark
                                {% elif event.event_type == 'deleted' %}bg-danger
                                {% endif %}">
                                {{ event.event_type.upper() }}
                            </span>
                        </td>
                        <td><code>{{ event.file_path }}</code></td>
                        <td>{{ event.endpoint }}</td>
                        <td>{{ event.hostname }}</td>
                        <td>{{ event.username }}</td>
                        <td>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-primary info-btn" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#hashModal"
                                    data-timestamp="{{ event.timestamp }}"
                                    data-file-path="{{ event.file_path }}"
                                    data-event-type="{{ event.event_type }}"
                                    data-hash-before="{{ event.hash_before or '-' }}"
                                    data-hash-after="{{ event.hash_after or '-' }}"
                                    onclick="showHashModal(this)">
                                Info
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-4 text-center text-muted">
            <p>No events found.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Hash Info Modal -->
<div class="modal fade" id="hashModal" tabindex="-1" aria-labelledby="hashModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hashModalLabel">File Hash Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Timestamp:</strong>
                    <div class="mt-1" id="timestampValue">-</div>
                </div>
                <div class="mb-3">
                    <strong>File Path:</strong>
                    <div class="mt-1"><code id="filePathValue">-</code></div>
                </div>
                <div class="mb-3">
                    <strong>Event Type:</strong>
                    <div class="mt-1" id="eventTypeValue">-</div>
                </div>
                <div class="mb-3">
                    <strong>Hash Before:</strong>
                    <div class="hash-value mt-1" id="hashBeforeValue">-</div>
                </div>
                <div class="mb-3">
                    <strong>Hash After:</strong>
                    <div class="hash-value mt-1" id="hashAfterValue">-</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function showHashModal(button) {
        const timestamp = button.getAttribute('data-timestamp');
        const filePath = button.getAttribute('data-file-path');
        const eventType = button.getAttribute('data-event-type');
        const hashBefore = button.getAttribute('data-hash-before');
        const hashAfter = button.getAttribute('data-hash-after');
        
        document.getElementById('timestampValue').textContent = timestamp;
        document.getElementById('filePathValue').textContent = filePath;
        document.getElementById('eventTypeValue').textContent = eventType.toUpperCase();
        document.getElementById('hashBeforeValue').textContent = hashBefore;
        document.getElementById('hashAfterValue').textContent = hashAfter;
    }
    
    function toggleAdvancedFilter() {
        const filterDiv = document.getElementById('advancedFilter');
        filterDiv.classList.toggle('show');
    }
    
    function resetFilters() {
        // Reset checkboxes
        document.querySelectorAll('.event-type-checkbox').forEach(cb => {
            if (cb.value === 'all') {
                cb.checked = true;
            } else {
                cb.checked = false;
            }
        });
        
        document.querySelectorAll('.column-checkbox').forEach(cb => {
            if (cb.value === 'all') {
                cb.checked = true;
            } else {
                cb.checked = false;
            }
        });
        
        // Submit form
        document.getElementById('filterForm').submit();
    }
    
    // Handle column checkbox "All" logic
    document.querySelectorAll('.column-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.value === 'all' && this.checked) {
                document.querySelectorAll('.column-checkbox').forEach(cb => {
                    if (cb.value !== 'all') cb.checked = false;
                });
            } else if (this.value !== 'all' && this.checked) {
                document.getElementById('colAll').checked = false;
            }
        });
    });
    
    // Handle event type checkbox "All" logic
    document.querySelectorAll('.event-type-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.value === 'all' && this.checked) {
                document.querySelectorAll('.event-type-checkbox').forEach(cb => {
                    if (cb.value !== 'all') cb.checked = false;
                });
            } else if (this.value !== 'all' && this.checked) {
                document.getElementById('eventAll').checked = false;
            }
        });
    });
    
    // Update hidden inputs on filter form submit
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            updateHiddenInputs();
            document.getElementById('mainForm').submit();
        });
    }
    
    // Handle search form submission
    const mainForm = document.getElementById('mainForm');
    if (mainForm) {
        mainForm.addEventListener('submit', function(e) {
            updateHiddenInputs();
        });
    }
    
    function updateHiddenInputs() {
        // Collect event types
        const eventTypes = [];
        document.querySelectorAll('.event-type-checkbox:checked').forEach(cb => {
            if (cb.value !== 'all') {
                eventTypes.push(cb.value);
            }
        });
        const eventTypesInput = document.getElementById('eventTypesInput');
        if (eventTypesInput) {
            eventTypesInput.value = eventTypes.length > 0 ? eventTypes.join(',') : '';
        }
        
        // Collect search columns
        const columns = [];
        const allChecked = document.getElementById('colAll')?.checked;
        if (!allChecked) {
            document.querySelectorAll('.column-checkbox:checked').forEach(cb => {
                if (cb.value !== 'all') {
                    columns.push(cb.value);
                }
            });
        }
        const searchColumnsInput = document.getElementById('searchColumnsInput');
        if (searchColumnsInput) {
            searchColumnsInput.value = columns.length > 0 ? columns.join(',') : '';
        }
    }
    
    // Show advanced filter if filters are active
    {% if has_active_filters %}
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('advancedFilter').classList.add('show');
    });
    {% endif %}
</script>
{% endblock %}
